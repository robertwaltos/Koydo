import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';

// Load Env (Simplified)
const envPath = path.resolve('.env');
let env = {};
if (fs.existsSync(envPath)) {
  const content = fs.readFileSync(envPath, 'utf8');
  content.split(/\r?\n/).forEach(line => {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) return;
    const idx = trimmed.indexOf('=');
    if (idx > -1) {
      env[trimmed.substring(0, idx).trim()] = trimmed.substring(idx + 1).trim();
    }
  });
}
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.EXPO_PUBLIC_SUPABASE_URL || env.NEXT_PUBLIC_SUPABASE_URL || env.EXPO_PUBLIC_SUPABASE_URL;
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || env.SUPABASE_SERVICE_ROLE_KEY;
const supabase = createClient(supabaseUrl, serviceKey);

async function main() {
  console.log('Compiling media assets to codebase...');
  
  const { data: jobs, error } = await supabase
    .from('media_generation_jobs')
    .select('lesson_id, output_url, asset_type, prompt, completed_at, updated_at')
    .eq('status', 'completed')
    .not('output_url', 'is', null)
    .order('completed_at', { ascending: false, nullsFirst: false })
    .order('updated_at', { ascending: false, nullsFirst: false });

  if (error) {
    console.error('Fetch error:', error.message);
    process.exit(1);
  }

  const seenLessonIds = new Set();
  const dedupedJobs = [];
  for (const job of jobs) {
    if (!job.lesson_id || seenLessonIds.has(job.lesson_id)) {
      continue;
    }
    seenLessonIds.add(job.lesson_id);
    dedupedJobs.push(job);
  }

  const items = dedupedJobs.map(job => {
     let alt = 'Educational media asset';
     const match = job.prompt ? job.prompt.match(/Subject: ([^.]+)/) : null;
     if (match) alt = match[1];

     return `  ${JSON.stringify(job.lesson_id)}: {\n    url: ${JSON.stringify(job.output_url)},\n    type: ${JSON.stringify(job.asset_type)},\n    alt: ${JSON.stringify(alt)}\n  }`;
  });

  const content = `// Auto-generated by scripts/compile-media-assets.mjs
// Do not edit manually.

export type MediaAsset = {
  url: string;
  type: string;
  alt: string;
};

export const GENERATED_MEDIA_ASSETS: Record<string, MediaAsset> = {
${items.join(',\n')}
};
`;

  const outputPath = path.resolve('src/lib/media/generated-media-assets.ts');
  fs.writeFileSync(outputPath, content);
  console.log(`Generated ${outputPath} with ${dedupedJobs.length} unique assets (${jobs.length - dedupedJobs.length} duplicates dropped).`);
}

main();
